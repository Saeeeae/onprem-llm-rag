# =============================================================================
# Development Environment Overrides
# =============================================================================
# Copy this file to docker-compose.override.yml and customize as needed:
#   cp docker-compose.override.example.yml docker-compose.override.yml
#
# docker-compose.override.yml is gitignored for local customization
# Docker Compose automatically merges this with docker-compose.yml
# =============================================================================

version: '3.8'

services:
  # =============================================================================
  # Backend - Development Mode with Hot-Reload
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/app:/app/app
      - ./backend/logs:/app/logs
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - DEBUG=true
    ports:
      - "5678:5678"  # debugpy for remote debugging (VSCode/PyCharm)

  # =============================================================================
  # Frontend - Development Mode with Fast Refresh
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/package.json:/app/package.json
      - /app/node_modules  # Anonymous volume to prevent host overwrite
      - /app/.next          # Preserve Next.js build cache
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000

  # =============================================================================
  # Celery Worker - Development Mode with Debug Logging
  # =============================================================================
  celery_worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./worker:/app
      - ./worker/logs:/app/logs
    command: celery -A celery_app worker --loglevel=debug --concurrency=1 --pool=solo
    environment:
      - LOG_LEVEL=DEBUG
      - ENVIRONMENT=development

  # =============================================================================
  # Celery Beat - Development Mode
  # =============================================================================
  celery_beat:
    build:
      context: ./worker
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./worker:/app

  # =============================================================================
  # Flower - Enable for Development Monitoring
  # =============================================================================
  flower:
    build:
      context: ./worker
      dockerfile: Dockerfile
      target: development
    profiles: []  # Remove profile requirement for development

  # =============================================================================
  # OCR Service - Development Mode with Debugging
  # =============================================================================
  ocr_service:
    build:
      context: ./services/ocr
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./services/ocr/ocr_service.py:/app/ocr_service.py
      - ./services/ocr/tests:/app/tests
    environment:
      - LOG_LEVEL=DEBUG
      - OCR_MODEL_PATH=${OCR_MODEL_PATH:-zai-org/GLM-OCR}
    ports:
      - "5679:5679"  # debugpy for remote debugging

  # =============================================================================
  # Embedding Service - Development Mode with Debugging
  # =============================================================================
  embedding_service:
    build:
      context: ./services/embedding
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./services/embedding/embedding_service.py:/app/embedding_service.py
      - ./services/embedding/tests:/app/tests
    environment:
      - LOG_LEVEL=DEBUG
      - EMBEDDING_MODEL_PATH=${EMBEDDING_MODEL_PATH:-intfloat/multilingual-e5-large}
    ports:
      - "5680:5680"  # debugpy for remote debugging

  # =============================================================================
  # Chunking Service - Development Mode with Debugging
  # =============================================================================
  chunking_service:
    build:
      context: ./services/chunking
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./services/chunking/chunking_service.py:/app/chunking_service.py
      - ./services/chunking/tests:/app/tests
    environment:
      - LOG_LEVEL=DEBUG
    ports:
      - "5681:5681"  # debugpy for remote debugging

  # =============================================================================
  # vLLM Service - Development Mode (Optional: Lightweight Model)
  # =============================================================================
  # Uncomment to use a lightweight model for faster development iteration
  # vllm_service:
  #   environment:
  #     - MODEL_NAME=TinyLlama/TinyLlama-1.1B-Chat-v1.0
  #     - MAX_MODEL_LEN=2048
  #     - MAX_NUM_SEQS=32
  #     - GPU_MEMORY_UTILIZATION=0.70

# =============================================================================
# Development Workflow
# =============================================================================
#
# 1. Copy this file:
#    cp docker-compose.override.example.yml docker-compose.override.yml
#
# 2. Start development environment:
#    docker compose up -d
#
# 3. Watch logs:
#    docker compose logs -f backend frontend
#
# 4. Make code changes - hot-reload will apply automatically!
#
# 5. Run tests:
#    docker compose exec backend pytest
#    docker compose exec frontend npm test
#
# 6. Attach debugger:
#    - Backend: VSCode/PyCharm to localhost:5678
#    - OCR: localhost:5679
#    - Embedding: localhost:5680
#    - Chunking: localhost:5681
#
# 7. Rebuild after dependency changes:
#    docker compose build backend
#    docker compose up -d backend
#
# =============================================================================
# VSCode Remote Debugging Configuration
# =============================================================================
#
# Add to .vscode/launch.json:
# {
#   "version": "0.2.0",
#   "configurations": [
#     {
#       "name": "Backend Remote Debug",
#       "type": "python",
#       "request": "attach",
#       "connect": {
#         "host": "localhost",
#         "port": 5678
#       },
#       "pathMappings": [
#         {
#           "localRoot": "${workspaceFolder}/backend/app",
#           "remoteRoot": "/app/app"
#         }
#       ]
#     },
#     {
#       "name": "OCR Service Remote Debug",
#       "type": "python",
#       "request": "attach",
#       "connect": {
#         "host": "localhost",
#         "port": 5679
#       },
#       "pathMappings": [
#         {
#           "localRoot": "${workspaceFolder}/services/ocr",
#           "remoteRoot": "/app"
#         }
#       ]
#     }
#   ]
# }
#
# =============================================================================
